{% extends 'blank.html' %}
{% load tags %}


{% block extra_css %}
    <link href="/static/mycss.css" rel="stylesheet">
    <link href="/static/assets/plugins/select2/dist/css/select2.min.css" rel="stylesheet" type="text/css">
{% endblock %}


{% block navbar_after_ul %}
    <button class="btn waves-effect waves-light btn-warning" onclick="showExpireEditor()"><i class="mdi mdi-grease-pencil"></i>修改</button>
{#    <button class="btn waves-effect waves-light btn-info" onclick=""><i class="mdi mdi-code-braces"></i>详情</button>#}
    <button class="btn waves-effect waves-light btn-danger" onclick="setFinish()"><i class="mdi mdi-check"></i>办结</button>
{% endblock %}


{% block extra_js %}
    <script src="/static/assets/plugins/select2/dist/js/select2.full.min.js" type="text/javascript"></script>
{#    <script src="/static/assets/plugins/dropify/dist/js/dropify.min.js"></script>#}
    <script src="/static/js/waves.js"></script>
    <script type="text/javascript" src="/static/myjs/common.js"></script>
    <script type="text/javascript" src="/static/myjs/formOperation.js"></script>
    <script type="text/javascript">
        FILTER = {{ filter | safe}};
        TODAY = '{% now "Y-m-d" %}';
        $(function(){
            refreshData();
        });

        function refreshData(){
            buildExpireList();
            renderExpireList();
            lockThead('main_content');
        }

        function buildExpireList(){
            $.post({
                url: '{% url "viewExpirePromptTable" %}',
                data: FILTER,
                dataType: 'json',
                async: false,
                success: function(response){
                    let tableCol = response[0],
                        tableColOrder = response[1],
                        dataList = response[2];
                    let table = makeListHtml(tableCol, tableColOrder, dataList);
                    $('#main_content').html(table);

                }
            })
        }

        function renderExpireList(){
            $('td[yr_card]').each(function(index, elem){
                let yr_card = Number(elem.getAttribute('yr_card'));
                if(yr_card === 1){
                    $(elem).addClass('text-warning text-semibold');
                }else if(yr_card > 1){
                    $(elem).addClass('text-danger text-semibold');
                }
            });
            $('td[expire_id]').each(function(index, elem){
                let expireId = elem.getAttribute('expire_id');
                let $radio = $(
                    '<div style="width: 0; height: 0;">' +
                        '<input type="radio" id="expire_' + expireId + '" expire_id="' + expireId + '" name="expire_id">' +
                        '<label for="expire_' + expireId + '" class=""></label>' +
                    '</div>'
                );
                elem.innerText = '';
                elem.append($radio[0]);
            });
        }

        function judgeExpireId(){
            let $radio = $('input[expire_id]');
            for(let i=0; i<$radio.length; i++){
                if($radio[i].checked){
                    return $radio[i].getAttribute('expire_id');
                }
            }
            alert('请选择一条记录');
        }

        function showExpireEditor(){
            if(FILTER.is_finished.includes('1')){
                alert('已办结，不可修改');
                return;
            }
            let expireId = judgeExpireId();
            if(!expireId){
                return false;
            }
            window.open('{% url "editExpirePrompt" %}' + '?pk=' + expireId, '_blank');
        }

        function setFinish(){
            if(FILTER.is_finished.includes('1')){
                alert('已办结，不可再次办结');
                return;
            }
            if(confirm('确认办结')){
                let pk = judgeExpireId();
                $.post({
                    url: '{% url "finishExpirePrompt" %}',
                    data: {pk: pk},
                    dataType: 'json',
                    success: function (data) {
                        if(data.success){
                            swal({
                                title: '操作成功',
                                showCancelButton: false
                            });
                            refreshData();
                        }else{
                            alert(data.error);
                            swal({
                                title: data.error,
                                type: 'error',
                            });
                        }
                    }
                });
            }
        }

    </script>
{% endblock %}